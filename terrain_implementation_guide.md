# 地形生成アルゴリズム改善版v4 - 実装ガイド

## 概要

等距離線に沿った正しい高度変化を実現するため、`_create_angle_based_height_map()` メソッドを改善版に置き換えます。

## 改善のポイント

### 従来の問題
1. **境界付近のみ変化**: `influence_range`内でのみ高度が変化
2. **中央部の不連続**: 角度判定で鋭利な高度差が発生
3. **ピクセル単位の範囲指定**: 等距離線の特性を活かせていない

### 改善版の特徴
1. **等距離線に沿った変化**: 境界からの正規化距離(0-1)で管理
2. **崖と坂の正しい特性**:
   - **崖**: 境界付近30%の範囲で急激に変化、中央70%はほぼ平坦
   - **坂**: 全範囲(0-100%)で線形的に高度が変化
3. **方向別の滑らかな補間**: 全方向からの寄与を重み付き平均で統合

## 実装手順

### ステップ1: `terrain_voxel_v3.ipynb`を開く

Jupyter Notebookを開きます。

### ステップ2: `_create_angle_based_height_map`メソッドを置き換え

cell-3の`VoronoiTerrain`クラス内の`_create_angle_based_height_map`メソッドを、以下の改善版に置き換えます。

**置き換え対象**:
- 開始: `def _create_angle_based_height_map(self):`
- 終了: `return height_map` (メソッドの最後)

**改善版コード**: `terrain_voxel_v4_improved.py` の内容をコピーして貼り付け

### ステップ3: セルを再実行

1. cell-3 (クラス定義) を再実行
2. cell-5 (地形生成) を再実行
3. cell-7 (2D可視化) を再実行
4. cell-9 (3D可視化) を再実行
5. cell-13 (傾斜角度検証) を再実行

### ステップ4: 結果を確認

以下の点を確認します:

#### 2D可視化 (cell-7)
- **高度マップ**: 境界から中心に向けて滑らかに色が変化
- **等距離線**: マトリョーシカ状に高度が変化
- **不連続点**: 中央付近の鋭利な高度差がないこと

#### 3D可視化 (cell-9)
- **坂（緑の境界）**: 広い範囲で緩やかに傾斜
- **崖（赤の境界）**: 境界付近で急峻、中央部は平坦
- **滑らかさ**: 鋭利なピークや谷がないこと

#### 傾斜角度統計 (cell-13)
- **30-40度の坂**: 増加していること
- **急峻な坂(40度以上)**: 境界付近に限定されていること
- **平地(0-10度)**: 中央部で適度に存在すること

## 期待される改善効果

### 定量的な目標
- 30-40度の緩やかな坂: 現状 < 10% → 目標 20-30%
- 平地(0-10度): 現状 > 70% → 目標 40-50%
- 急峻(40度以上): 現状 < 20% → 目標 20-30%

### 定性的な改善
1. **自然な地形**: 等距離線に沿った連続的な高度変化
2. **不連続の解消**: 中央部の鋭利な高度差がなくなる
3. **崖と坂の特性**: 各境界タイプの特性が正しく表現される

## トラブルシューティング

### 問題1: まだ不連続が残る
**原因**: 角度の閾値が厳しすぎる
**対処**: `cos_angle < 0.3` を `cos_angle < 0.2` に緩和

### 問題2: 崖が緩やかすぎる
**原因**: べき乗の値が小さい
**対処**: `t ** 0.3` を `t ** 0.2` にしてより急峻に

### 問題3: 坂が急すぎる
**原因**: 線形減衰が強すぎる
**対処**: `distance_weight = 1.0 - normalized_dist_to_boundary` を
         `distance_weight = (1.0 - normalized_dist_to_boundary) ** 0.7` に

### 問題4: 境界付近で段差が発生
**原因**: 方向重みの強調が強すぎる
**対処**: `angle_weight ** 1.5` を `angle_weight ** 1.0` に緩和

## コードの主要部分の解説

### 正規化距離の計算
```python
# 領域の最大距離（中心付近）を取得
max_distance = max(dist_to_boundary_map.values())

# 正規化距離（0=境界、1=中心）
normalized_dist = min_dist_to_any_boundary / max_distance
```

### 崖の高度変化（境界付近30%のみ）
```python
if normalized_dist_to_boundary < 0.3:
    t = normalized_dist_to_boundary / 0.3
    distance_weight = 1.0 - (t ** 0.3)  # 急峻
else:
    distance_weight = 0.0  # 中央部は影響なし
```

### 坂の高度変化（全範囲で線形）
```python
distance_weight = 1.0 - normalized_dist_to_boundary
```

### 方向別の寄与の統合
```python
# 重み付き平均で最終高度を計算
for contrib in contributions:
    normalized_weight = contrib['weight'] / total_weight
    blend_height = base_height + (neighbor_height - base_height) * contrib['weight']
    weighted_height += blend_height * normalized_weight
```

## 次のステップ

1. ✅ 基本的な動作確認
2. パラメータの微調整（崖の範囲、べき乗の値など）
3. 大規模な地形での検証（200×200ピクセル）
4. 実際のゲームエンジンへの統合

## まとめ

この改善版では、**等距離線を等高線的に扱う**ことで、自然で連続的な地形を生成できます。崖は境界付近で急激に、坂は全範囲で緩やかに変化し、方向間の補間も滑らかになります。
