# 地形生成改善 - 完了レポート

## 改善の経緯

### 初期問題（v3）
- 高低差が激しく不連続で不自然な地形
- 領域中心部で急激な高度変化
- 境界付近での高度逆転（高い→低いが途中で高くなる）

### 解決プロセス

#### v5: 方向ベースの区分導入
- 等距離線を方向によって区分する概念を導入
- cos_angleで主境界を選択
- **問題**: 補間ロジックが不適切で区分境界に直線的な段差

#### v6-v7: 補間ロジックの改善試行
- 外積による「間」判定を実装
- **問題**: 高度逆転が解決せず、領域内部で不自然な変化

#### v8: 高度逆転問題の根本解決 ✅
- **根本原因**: `primary_height = base_height * (1-blend) + neighbor_height * blend`
  - 隣が高いと上がる、隣が低いと下がる（間違い）
- **修正**: 壁は高い側のみ下がる、坂は中間高度に向かう
- **結果**: 高度逆転が完全に解消

#### v9: 区分境界の滑らか化
- 高度逆転を起こさない範囲での補間を追加
- base_heightから遠ざかる補間を防止
- **結果**: 区分境界での不連続が改善

#### v10: パラメータ調整（最終版） ✅
- 崖・坂の範囲を拡大（8m→12m、30m→45m）
- power値を調整（0.2→0.3、0.7→0.8）
- 高度差を縮小（46.8m→24.1m）
- **結果**: 自然ななだらかな地形を実現

## 最終結果（v10）

### 統計比較

| 指標 | v3（初期） | v10（最終） | 改善 |
|------|-----------|------------|------|
| 高度差 | 42.9m | 24.1m | ✅ 自然な範囲 |
| 平地（0-10度） | - | 60.8% | ✅ 安全エリア確保 |
| 緩やか（10-40度） | 3.9% | 22.0% | ✅ 5.6倍増加 |
| 急峻（40度以上） | 63.4% | 17.3% | ✅ 73%減少 |
| 平均傾斜角度 | 42.2度 | 17.3度 | ✅ 自然な傾斜 |

### 主要な改善点

1. **高度逆転の完全解消**
   - 境界に近づくと高度が上がる不自然な現象を修正
   - 高い領域から低い領域への一方向の変化を実現

2. **区分境界の滑らか化**
   - 同じ領域内での直線的な段差を改善
   - 高度逆転を起こさない範囲での適切な補間

3. **自然な傾斜角度**
   - 崖: 74度 → 約60-65度（適切な崖の角度）
   - 坂: 32度 → 約20-25度（緩やかな丘）

4. **バランスの取れた地形構成**
   - 平地: 60.8%（活動エリア）
   - 緩やか: 22.0%（移動可能な境界）
   - 急峻: 17.3%（危険エリア）

## 最終パラメータ

```python
# 崖の設定
cliff_range = 12.0  # m（影響範囲）
cliff_power = 0.3   # 急峻さ

# 坂の設定
slope_range = 45.0  # m（影響範囲）
slope_power = 0.8   # 線形に近い

# 高度の設定
初期高度範囲 = 35-55m
通路高度差 = 1.5-3m
壁最低高度差 = 12m

# 構成
壁（崖）: 11個（34.4%）
通路（坂）: 21個（65.6%）
```

## アルゴリズムの核心

### 高度計算ロジック（v10）

```python
# 1. 主境界の選択（cos_angle最大）
primary_boundary = max(boundary_info, key=lambda b: b['cos_angle'])

# 2. 距離ベースのblend計算
if is_wall:
    blend = 1.0 - (distance / cliff_range) ** cliff_power
else:
    blend = 1.0 - (distance / slope_range) ** slope_power

# 3. 高度計算（高度逆転防止）
if is_wall:
    if base_height > neighbor_height:
        # 高い側: 低い方へ下がる
        primary_height = base_height * (1.0 - blend) + neighbor_height * blend
    else:
        # 低い側: 変化なし
        primary_height = base_height
else:
    # 坂: 中間高度に向かう
    boundary_height = (base_height + neighbor_height) / 2.0
    primary_height = base_height * (1.0 - blend) + boundary_height * blend

# 4. 区分境界での補間（オプション、v9-v10）
if in_section_boundary:
    # base_heightから遠ざからない範囲で補間
    if abs(secondary_height - base_height) < abs(primary_height - base_height) * 1.5:
        final_height = primary_height * (1.0 - weight) + secondary_height * weight
    else:
        final_height = primary_height
```

## 今後の調整オプション

### より険しい地形（冒険向け）
```python
cliff_range = 10.0  # より急な崖
壁最低高度差 = 18m  # 大きな段差
壁の割合 = 45%      # 崖を増やす
```

### より緩やかな地形（探索向け）
```python
slope_range = 50.0  # より緩やかな坂
壁最低高度差 = 8m   # 小さな段差
通路比率 = 75%      # 坂を増やす
```

### バランス型（推奨、現行v10）
```python
# 現在のパラメータを維持
# 自然で探索しやすい地形
```

## 技術的知見

### 重要な洞察

1. **等距離線の正しい解釈**
   - 境界からの距離で高度が決まる
   - 方向によって区分され、各ピクセルは1つの境界に属する

2. **高度逆転の原因**
   - `neighbor_height`への直接的な補間が原因
   - 高い→低いの一方向変化の原則を守る必要がある

3. **区分境界の扱い**
   - 主境界が切り替わるラインで段差が生じる
   - 補間は必要だが、高度逆転を起こさない範囲で限定的に

4. **パラメータのバランス**
   - cliff_range vs slope_rangeの比率が重要
   - power値は0.2-0.8の範囲で調整
   - 高度差は地形全体のスケールに影響

## ファイル一覧

- `terrain_voxel_v10_adjusted.py`: 最終推奨版（✅使用推奨）
- `terrain_voxel_v9_smooth.py`: 区分境界補間あり
- `terrain_voxel_v8_fixed.py`: 高度逆転修正版
- その他のバージョン: 開発過程の記録

## 結論

地形生成の改善は成功しました。v10は以下を達成しています：

✅ 高度逆転の完全解消
✅ 自然ななだらかな地形
✅ 適切な崖と坂のバランス
✅ 滑らかな区分境界遷移

現在のパラメータは、自然な地形として最適なバランスを実現しており、
特別な要件がない限り、このまま採用することを推奨します。
